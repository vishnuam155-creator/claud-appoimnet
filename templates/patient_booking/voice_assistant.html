<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant - MediBot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            text-align: center;
        }

        .assistant-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1em;
            margin-bottom: 30px;
        }

        /* AI Wave Animation */
        .wave-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            opacity: 0.4;
            animation: pulse 2s ease-in-out infinite;
        }

        .wave:nth-child(2) {
            animation-delay: 0.3s;
            opacity: 0.3;
        }

        .wave:nth-child(3) {
            animation-delay: 0.6s;
            opacity: 0.2;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(0.5);
                opacity: 0.4;
            }
            50% {
                transform: scale(1);
                opacity: 0.1;
            }
        }

        .mic-icon {
            position: relative;
            z-index: 10;
            font-size: 60px;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .mic-icon.listening {
            color: #f43f5e;
            animation: glow 1.5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% {
                filter: drop-shadow(0 0 10px #f43f5e);
            }
            50% {
                filter: drop-shadow(0 0 20px #f43f5e);
            }
        }

        /* Status and Messages */
        .status {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
            min-height: 30px;
        }

        .status.listening {
            color: #f43f5e;
        }

        .message-display {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: 20%;
            text-align: right;
        }

        .message.bot {
            background: #e2e8f0;
            color: #334155;
            margin-right: 20%;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #334155;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Transcript */
        .transcript {
            background: #f8fafc;
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 0.9em;
            color: #64748b;
            max-height: 100px;
            overflow-y: auto;
        }

        .transcript-label {
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
        }

        /* Loading */
        .loading {
            display: inline-block;
        }

        .loading:after {
            content: '.';
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .assistant-card {
                padding: 30px 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .wave-container {
                width: 150px;
                height: 150px;
            }

            .mic-icon {
                font-size: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="assistant-card">
            <h1>ü§ñ MediBot Voice Assistant</h1>
            <p class="subtitle">Your AI-Powered Medical Appointment Booking Assistant</p>

            <!-- AI Wave Animation -->
            <div class="wave-container">
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="wave"></div>
                <div class="mic-icon" id="micIcon">üé§</div>
            </div>

            <!-- Status -->
            <div class="status" id="status">Click "Start" to begin</div>

            <!-- Message Display -->
            <div class="message-display" id="messageDisplay">
                <div class="message bot">
                    Hello! I'm MediBot, your voice medical assistant. Click "Start" and I'll help you book an appointment.
                </div>
            </div>

            <!-- Transcript -->
            <div class="transcript">
                <div class="transcript-label">You're saying:</div>
                <div id="transcript">...</div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startVoiceAssistant()">
                    <span>‚ñ∂Ô∏è</span> Start
                </button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopVoiceAssistant()" disabled>
                    <span>‚èπÔ∏è</span> Stop
                </button>
            </div>
        </div>
    </div>

    <script>
        // Voice Assistant State
        let isListening = false;
        let recognition = null;
        let sessionId = 'voice_' + Date.now();
        let sessionData = {};
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return null;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-IN';

            let finalTranscript = '';
            let silenceTimer = null;

            recognition.onstart = () => {
                console.log('Voice recognition started');
                updateStatus('Listening...', true);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update transcript display
                document.getElementById('transcript').textContent =
                    interimTranscript || finalTranscript || '...';

                // Clear previous silence timer
                if (silenceTimer) clearTimeout(silenceTimer);

                // Set new silence timer (1.5 seconds of silence)
                if (finalTranscript.trim()) {
                    silenceTimer = setTimeout(() => {
                        if (finalTranscript.trim() && !isSpeaking) {
                            processSpeech(finalTranscript.trim());
                            finalTranscript = '';
                            document.getElementById('transcript').textContent = '...';
                        }
                    }, 1500);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    // Restart if no speech detected
                    if (isListening && !isSpeaking) {
                        recognition.start();
                    }
                }
            };

            recognition.onend = () => {
                console.log('Voice recognition ended');
                // Auto-restart if still in listening mode and not speaking
                if (isListening && !isSpeaking) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 100);
                } else {
                    updateStatus('Click "Start" to begin', false);
                }
            };

            return recognition;
        }

        // Start Voice Assistant
        function startVoiceAssistant() {
            if (!recognition) {
                recognition = initSpeechRecognition();
                if (!recognition) return;
            }

            isListening = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            try {
                recognition.start();

                // Send initial greeting
                fetch('/api/voice-assistant/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: '',
                        session_id: sessionId,
                        session_data: sessionData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    addMessage(data.message, 'bot');
                    speak(data.message);
                    sessionData = data.data || {};
                });

            } catch (e) {
                console.error('Failed to start recognition:', e);
                alert('Failed to start voice recognition. Please try again.');
                resetVoiceAssistant();
            }
        }

        // Stop Voice Assistant
        function stopVoiceAssistant() {
            isListening = false;

            if (recognition) {
                recognition.stop();
            }

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateStatus('Stopped', false);

            // Reset session
            sessionId = 'voice_' + Date.now();
            sessionData = {};
        }

        // Reset Voice Assistant
        function resetVoiceAssistant() {
            stopVoiceAssistant();
            document.getElementById('messageDisplay').innerHTML = `
                <div class="message bot">
                    Hello! I'm MediBot, your voice medical assistant. Click "Start" and I'll help you book an appointment.
                </div>
            `;
        }

        // Process Speech
        function processSpeech(message) {
            if (!message || message.trim() === '') return;

            // Add user message to display
            addMessage(message, 'user');

            // Update status
            updateStatus('Processing<span class="loading"></span>', false);

            // Stop listening while processing
            if (recognition && isListening) {
                recognition.stop();
            }

            // Send to backend
            fetch('/api/voice-assistant/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionId,
                    session_data: sessionData
                })
            })
            .then(response => response.json())
            .then(data => {
                // Add bot response
                addMessage(data.message, 'bot');

                // Update session data
                sessionData = data.data || {};

                // Speak response
                speak(data.message);

                // Check if completed
                if (data.action === 'booking_complete') {
                    setTimeout(() => {
                        if (confirm('Booking completed! Would you like to book another appointment?')) {
                            resetVoiceAssistant();
                            startVoiceAssistant();
                        } else {
                            stopVoiceAssistant();
                        }
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                updateStatus('Listening...', true);

                // Restart listening
                if (isListening) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Restart failed:', e);
                        }
                    }, 500);
                }
            });
        }

        // Text-to-Speech
        function speak(text) {
            // Cancel any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            isSpeaking = true;
            updateStatus('Speaking...', false);

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            utterance.rate = 0.9;
            utterance.pitch = 1;

            // Select a pleasant voice
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice =>
                voice.name.includes('Google') && voice.lang.startsWith('en')
            ) || voices.find(voice => voice.lang.startsWith('en'));

            if (preferredVoice) {
                utterance.voice = preferredVoice;
            }

            utterance.onend = () => {
                isSpeaking = false;
                console.log('Speech ended');

                // Resume listening after speaking
                if (isListening) {
                    updateStatus('Listening...', true);
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Recognition already started or error:', e);
                        }
                    }, 500);
                }
            };

            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                isSpeaking = false;

                // Resume listening even if speech failed
                if (isListening) {
                    updateStatus('Listening...', true);
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 500);
                }
            };

            speechSynthesis.speak(utterance);
        }

        // Add Message to Display
        function addMessage(text, sender) {
            const messageDisplay = document.getElementById('messageDisplay');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messageDisplay.appendChild(messageDiv);

            // Scroll to bottom
            messageDisplay.scrollTop = messageDisplay.scrollHeight;

            // Keep only last 10 messages
            const messages = messageDisplay.querySelectorAll('.message');
            if (messages.length > 10) {
                messages[0].remove();
            }
        }

        // Update Status
        function updateStatus(text, listening) {
            const statusEl = document.getElementById('status');
            const micIcon = document.getElementById('micIcon');

            statusEl.innerHTML = text;

            if (listening) {
                statusEl.classList.add('listening');
                micIcon.classList.add('listening');
            } else {
                statusEl.classList.remove('listening');
                micIcon.classList.remove('listening');
            }
        }

        // Load voices (needed for speech synthesis)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {
                speechSynthesis.getVoices();
            };
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Preload voices
            speechSynthesis.getVoices();
        });
    </script>
</body>
</html>
