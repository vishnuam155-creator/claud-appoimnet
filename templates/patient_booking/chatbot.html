<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Medical Appointment Chatbot</title>

  <!-- ===== üé® STYLES ===== -->
  <style>
    /* ====== RESET & BASE ====== */
/* ====== RESET & BASE ====== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f9fafb;
  color: #111;
  display: flex;
  flex-direction: column;
}

/* ====== CHAT WRAPPER ====== */
.chat-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
  max-width: 900px;
  margin: auto;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 20px;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

/* ====== HEADER ====== */
.chat-header {
  background: #ffffff;
  border-bottom: 1px solid #e5e7eb;
  color: #111;
  padding: 18px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header h1 {
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.chat-header p {
  font-size: 14px;
  color: #6b7280;
}

/* ====== MAIN CHAT AREA ====== */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 30px 40px;
  background: #fafafa;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
}

.message {
  display: flex;
  margin-bottom: 20px;
  animation: fadeIn 0.4s ease forwards;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-content {
  max-width: 70%;
  padding: 14px 18px;
  border-radius: 16px;
  font-size: 15px;
  line-height: 1.6;
  word-wrap: break-word;
}

.bot-message {
  justify-content: flex-start;
}

.bot-message .message-content {
  background: #f3f4f6;
  color: #111;
  border-top-left-radius: 6px;
}

.user-message {
  justify-content: flex-end;
}

.user-message .message-content {
  background: #2563eb;
  color: white;
  border-top-right-radius: 6px;
}

/* ====== TYPING INDICATOR ====== */
.typing-indicator {
  display: none;
  align-self: flex-start;
  background: #f3f4f6;
  padding: 10px 16px;
  border-radius: 15px;
  margin-left: 10px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.typing-indicator span {
  height: 8px;
  width: 8px;
  background: #2563eb;
  display: inline-block;
  border-radius: 50%;
  margin-right: 4px;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); }
}

/* ====== OPTIONS ====== */
.options-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 0 40px 15px 40px;
}

.option-btn {
  padding: 8px 18px;
  border-radius: 20px;
  border: 1.8px solid #2563eb;
  background: #ffffff;
  color: #2563eb;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.option-btn:hover {
  background: #2563eb;
  color: white;
  transform: translateY(-2px);
}

.skip-btn {
  background: #f3f4f6;
  border-color: #d1d5db;
  color: #6b7280;
}

.skip-btn:hover {
  background: #e5e7eb;
}

/* ====== INPUT AREA ====== */
.input-area {
  display: flex;
  align-items: center;
  padding: 18px 30px;
  background: #ffffff;
  border-top: 1px solid #e5e7eb;
  gap: 10px;
}

#user-input {
  flex: 1;
  padding: 12px 20px;
  border: 1.5px solid #d1d5db;
  border-radius: 25px;
  background: #f9fafb;
  color: #111;
  font-size: 15px;
  outline: none;
  transition: all 0.3s ease;
}

#user-input::placeholder {
  color: #9ca3af;
}

#user-input:focus {
  border-color: #2563eb;
  background: #ffffff;
}

.voice-btn {
  padding: 12px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

#mic-btn {
  background: #10b981;
  color: white;
}

#mic-btn:hover {
  background: #059669;
  transform: scale(1.05);
}

#mic-btn.recording {
  background: #ef4444;
  animation: pulse 1.5s infinite;
}

#speaker-btn {
  background: #6366f1;
  color: white;
}

#speaker-btn:hover {
  background: #4f46e5;
  transform: scale(1.05);
}

#speaker-btn.disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

#send-btn {
  padding: 12px 22px;
  border-radius: 25px;
  background: #2563eb;
  color: white;
  border: none;
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.25s ease;
}

#send-btn:hover {
  background: #1e40af;
  transform: scale(1.05);
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
  }
  50% {
    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
  }
}

/* Voice status indicator */
.voice-status {
  display: none;
  padding: 8px 16px;
  background: #f3f4f6;
  border-radius: 15px;
  font-size: 13px;
  color: #6b7280;
  align-items: center;
  gap: 8px;
}

.voice-status.active {
  display: flex;
}

.voice-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #10b981;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ====== SCROLLBAR ====== */
.messages::-webkit-scrollbar {
  width: 6px;
}

.messages::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

.messages::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

@media (max-width: 768px) {
  .chat-wrapper {
    border-radius: 0;
  }
  .messages {
    padding: 20px;
  }
  .input-area {
    padding: 15px 20px;
  }
}
  </style>
</head>

<body>
  <!-- ===== üí¨ CHAT INTERFACE ===== -->
  <div class="chat-wrapper">
    <div class="chat-header">
      <h1><span>üè•</span> AI Medical Assistant</h1>
      <p>Helping you book appointments smarter</p>
    </div>

    <div class="messages" id="messages">
      <div class="message bot-message">
        <div class="message-content">
          Hello! üëã I‚Äôm your AI appointment assistant.<br><br>
          How can I assist you today?
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typing-indicator">
      <span></span><span></span><span></span>
    </div>

    <div class="options-container" id="options-container"></div>

    <div class="voice-status" id="voice-status">
      <span class="status-dot"></span>
      <span id="voice-status-text">Listening...</span>
    </div>

    <div class="input-area">
      <button class="voice-btn" id="mic-btn" title="Voice Input">üé§</button>
      <input type="text" id="user-input" placeholder="Type or speak your message..." autocomplete="off" />
      <button class="voice-btn" id="speaker-btn" title="Voice Output">üîä</button>
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- ===== ‚öôÔ∏è SCRIPT ===== -->
  <script>
    let sessionId = generateSessionId();
    let voiceEnabled = false;
    let isRecording = false;
    let recognition = null;
    let synthesis = window.speechSynthesis;

    // Initialize Web Speech API
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-IN'; // English (India)

      recognition.onstart = function() {
        isRecording = true;
        document.getElementById('mic-btn').classList.add('recording');
        document.getElementById('voice-status').classList.add('active');
        document.getElementById('voice-status-text').textContent = 'Listening...';
      };

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const confidence = event.results[0][0].confidence;

        document.getElementById('user-input').value = transcript;

        // Auto-send if confidence is high
        if (confidence > 0.7) {
          setTimeout(() => sendMessage(), 500);
        }
      };

      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopRecording();

        if (event.error === 'no-speech') {
          showVoiceStatus('No speech detected. Please try again.', 'error');
        } else if (event.error === 'not-allowed') {
          showVoiceStatus('Microphone access denied. Please enable it.', 'error');
        } else {
          showVoiceStatus('Voice recognition error. Please try typing.', 'error');
        }
      };

      recognition.onend = function() {
        stopRecording();
      };
    }

    function generateSessionId() {
      return "session_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    }

    function toggleVoiceInput() {
      if (!recognition) {
        alert('Voice recognition is not supported in your browser. Please use Chrome or Edge.');
        return;
      }

      if (isRecording) {
        recognition.stop();
      } else {
        try {
          recognition.start();
        } catch (error) {
          console.error('Error starting recognition:', error);
        }
      }
    }

    function stopRecording() {
      isRecording = false;
      document.getElementById('mic-btn').classList.remove('recording');
      document.getElementById('voice-status').classList.remove('active');
    }

    function toggleVoiceOutput() {
      voiceEnabled = !voiceEnabled;
      const speakerBtn = document.getElementById('speaker-btn');

      if (voiceEnabled) {
        speakerBtn.textContent = 'üîä';
        speakerBtn.classList.remove('disabled');
        showVoiceStatus('Voice output enabled', 'success');
      } else {
        speakerBtn.textContent = 'üîá';
        speakerBtn.classList.add('disabled');
        synthesis.cancel(); // Stop any ongoing speech
        showVoiceStatus('Voice output disabled', 'info');
      }

      // Hide status after 2 seconds
      setTimeout(() => {
        if (!isRecording) {
          document.getElementById('voice-status').classList.remove('active');
        }
      }, 2000);
    }

    function showVoiceStatus(message, type = 'info') {
      const statusEl = document.getElementById('voice-status');
      const statusText = document.getElementById('voice-status-text');

      statusText.textContent = message;
      statusEl.classList.add('active');

      // Auto-hide after 3 seconds
      setTimeout(() => {
        if (!isRecording) {
          statusEl.classList.remove('active');
        }
      }, 3000);
    }

    function speak(text) {
      if (!voiceEnabled || !synthesis) return;

      // Cancel any ongoing speech
      synthesis.cancel();

      // Remove HTML tags
      const cleanText = text.replace(/<[^>]+>/g, '').replace(/\n/g, '. ');

      const utterance = new SpeechSynthesisUtterance(cleanText);
      utterance.lang = 'en-IN';
      utterance.rate = 0.9; // Slightly slower for clarity
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      // Get Indian English voice if available
      const voices = synthesis.getVoices();
      const indianVoice = voices.find(voice =>
        voice.lang === 'en-IN' || voice.lang.startsWith('en-IN')
      );

      if (indianVoice) {
        utterance.voice = indianVoice;
      }

      utterance.onstart = function() {
        showVoiceStatus('Speaking...', 'info');
      };

      utterance.onend = function() {
        if (!isRecording) {
          document.getElementById('voice-status').classList.remove('active');
        }
      };

      synthesis.speak(utterance);
    }

    function addMessage(text, sender) {
      const messagesDiv = document.getElementById("messages");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}-message`;
      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      contentDiv.innerHTML = text.replace(/\n/g, "<br>");
      messageDiv.appendChild(contentDiv);
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displayOptions(options) {
      const container = document.getElementById("options-container");
      container.innerHTML = "";
      if (!options || options.length === 0) {
        container.style.display = "none";
        return;
      }
      container.style.display = "flex";
      options.forEach((option) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        if (option.value === "skip" || option.label.includes("Skip")) btn.classList.add("skip-btn");
        btn.textContent = option.label;
        btn.onclick = () => selectOption(option.value, option.label);
        container.appendChild(btn);
      });
    }

    function selectOption(value, label) {
      document.getElementById("options-container").innerHTML = "";
      sendMessage(value, label);
    }

    function showTypingIndicator() {
      document.getElementById("typing-indicator").style.display = "flex";
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    function hideTypingIndicator() {
      document.getElementById("typing-indicator").style.display = "none";
    }

    async function sendMessage(messageValue = null, displayText = null) {
      const input = document.getElementById("user-input");
      const message = messageValue || input.value.trim();
      const displayMessage = displayText || message;
      if (!message) return;
      addMessage(displayMessage, "user");
      if (!messageValue) input.value = "";
      showTypingIndicator();
      try {
        const response = await fetch("/api/chatbot/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, session_id: sessionId }),
        });
        const data = await response.json();
        hideTypingIndicator();
        if (data.success) {
          sessionId = data.session_id;
          addMessage(data.message, "bot");

          // Speak the response if voice is enabled
          if (voiceEnabled) {
            speak(data.message);
          }

          if (data.options) displayOptions(data.options);
          else document.getElementById("options-container").style.display = "none";
        } else addMessage("‚ö†Ô∏è Sorry, something went wrong. Please try again.", "bot");
      } catch (err) {
        hideTypingIndicator();
        addMessage("üåê Network error. Please check your connection.", "bot");
        console.error(err);
      }
    }

    // Event listeners
    document.getElementById("send-btn").addEventListener("click", () => sendMessage());
    document.getElementById("user-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    document.getElementById("mic-btn").addEventListener("click", toggleVoiceInput);
    document.getElementById("speaker-btn").addEventListener("click", toggleVoiceOutput);

    // Load voices when they become available
    if (synthesis) {
      synthesis.onvoiceschanged = function() {
        const voices = synthesis.getVoices();
        console.log('Available voices:', voices.length);
      };
    }

    window.onload = () => {
      document.getElementById("user-input").focus();

      // Show voice feature hint
      setTimeout(() => {
        const voiceHint = "üí° Tip: Click üé§ for voice input and üîä to hear responses!";
        const hintDiv = document.createElement("div");
        hintDiv.className = "message bot-message";
        hintDiv.innerHTML = `<div class="message-content" style="background: #dbeafe; color: #1e40af;">${voiceHint}</div>`;
        document.getElementById("messages").appendChild(hintDiv);
      }, 1000);
    };
  </script>
</body>
</html>
