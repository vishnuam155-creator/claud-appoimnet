;====================================================================================
; Asterisk Configuration Example for MediBot Voice Assistant Integration
;====================================================================================
;
; This file contains example Asterisk configurations for integrating with
; the MediBot Voice Assistant system.
;
; Files to configure:
; - /etc/asterisk/ari.conf         (Asterisk REST Interface)
; - /etc/asterisk/http.conf        (HTTP server configuration)
; - /etc/asterisk/extensions.conf  (Dialplan)
; - /etc/asterisk/pjsip.conf       (SIP trunk configuration)
;
;====================================================================================

;====================================================================================
; 1. ARI Configuration (/etc/asterisk/ari.conf)
;====================================================================================

[general]
enabled = yes
pretty = yes
allowed_origins = http://localhost:8000,https://yourdomain.com

[voicebot]
type = user
read_only = no
password = voicebot_secure_password_2024
; Change this to a strong password!

;====================================================================================
; 2. HTTP Configuration (/etc/asterisk/http.conf)
;====================================================================================

[general]
enabled = yes
bindaddr = 0.0.0.0
bindport = 8088

; For production, enable TLS:
; tlsenable = yes
; tlsbindaddr = 0.0.0.0:8089
; tlscertfile = /etc/asterisk/keys/asterisk.pem
; tlsprivatekey = /etc/asterisk/keys/asterisk.key

;====================================================================================
; 3. Dialplan Configuration (/etc/asterisk/extensions.conf)
;====================================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; Django API endpoint
VOICEBOT_API=http://localhost:8000/voicebot/api/asterisk

;====================================================================================
; Incoming Calls - Route to Voicebot
;====================================================================================

[incoming]
; Extension 100 - Main voicebot line
exten => 100,1,NoOp(Incoming call to voicebot)
    same => n,Answer()
    same => n,Wait(1)
    same => n,Set(CALLERID(num)=${CALLERID(num)})
    same => n,Set(CHANNEL_ID=${CHANNEL})
    same => n,Stasis(voicebot,incoming,${CALLERID(num)})
    same => n,Hangup()

; Extension 101 - Emergency line (bypass voicebot)
exten => 101,1,NoOp(Emergency call)
    same => n,Answer()
    same => n,Playback(emergency-greeting)
    same => n,Dial(SIP/emergency_number)
    same => n,Hangup()

; Pattern for DID numbers
exten => _X.,1,NoOp(DID: ${EXTEN})
    same => n,Goto(incoming,100,1)

;====================================================================================
; Outbound Calls - Voicebot initiated
;====================================================================================

[outbound]
; Outbound appointment reminders
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
    same => n,Set(CALLERID(name)=MediBot)
    same => n,Set(CALLERID(num)=1234567890)
    same => n,Dial(PJSIP/${EXTEN}@trunk,30,t)
    same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered:failed)
    same => n(answered),Stasis(voicebot,outbound,${EXTEN})
    same => n,Hangup()
    same => n(failed),NoOp(Call failed: ${DIALSTATUS})
    same => n,Hangup()

;====================================================================================
; Testing Extensions
;====================================================================================

[testing]
; Test extension for voicebot
exten => 200,1,NoOp(Test voicebot)
    same => n,Answer()
    same => n,Playback(beep)
    same => n,Stasis(voicebot,test)
    same => n,Hangup()

; Test audio recording
exten => 201,1,NoOp(Test recording)
    same => n,Answer()
    same => n,Playback(beep)
    same => n,Record(/var/spool/asterisk/recording/test-%d.wav,10,300)
    same => n,Playback(beep)
    same => n,Hangup()

; Echo test
exten => 202,1,NoOp(Echo test)
    same => n,Answer()
    same => n,Echo()
    same => n,Hangup()

;====================================================================================
; IVR Menu (Optional)
;====================================================================================

[ivr-main]
exten => s,1,NoOp(Main IVR)
    same => n,Answer()
    same => n,Wait(1)
    same => n(menu),Background(welcome-medibot)
    same => n,Background(press-1-for-appointment)
    same => n,Background(press-2-for-emergency)
    same => n,WaitExten(10)

; Option 1 - Appointment booking via voicebot
exten => 1,1,NoOp(User selected appointment booking)
    same => n,Goto(incoming,100,1)

; Option 2 - Emergency
exten => 2,1,NoOp(User selected emergency)
    same => n,Goto(incoming,101,1)

; Timeout
exten => t,1,NoOp(Timeout in IVR)
    same => n,Playback(goodbye)
    same => n,Hangup()

; Invalid option
exten => i,1,NoOp(Invalid option)
    same => n,Playback(invalid)
    same => n,Goto(s,menu)

;====================================================================================
; 4. PJSIP Configuration (/etc/asterisk/pjsip.conf)
;====================================================================================

[global]
max_forwards=70
user_agent=MediBot Asterisk
default_realm=yourdomain.com

;====================================================================================
; Transport Configuration
;====================================================================================

[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060

[transport-tcp]
type=transport
protocol=tcp
bind=0.0.0.0:5060

;====================================================================================
; SIP Trunk Configuration (Example: Twilio)
;====================================================================================

[trunk]
type=registration
transport=transport-udp
outbound_auth=trunk-auth
server_uri=sip:yourdomain.pstn.twilio.com
client_uri=sip:youraccountid@yourdomain.pstn.twilio.com
retry_interval=60

[trunk-auth]
type=auth
auth_type=userpass
username=youraccountid
password=yourpassword

[trunk-endpoint]
type=endpoint
context=incoming
disallow=all
allow=ulaw
allow=alaw
allow=opus
transport=transport-udp
auth=trunk-auth
aors=trunk-aor
from_domain=yourdomain.pstn.twilio.com

[trunk-aor]
type=aor
contact=sip:yourdomain.pstn.twilio.com

[trunk-identify]
type=identify
endpoint=trunk-endpoint
match=54.172.60.0/30
match=54.244.51.0/30

;====================================================================================
; 5. RTP Configuration (/etc/asterisk/rtp.conf)
;====================================================================================

[general]
rtpstart=10000
rtpend=20000
rtpchecksums=yes
dtmftimeout=3000
rtcpinterval=5000
strictrtp=yes
icesupport=yes
stunaddr=stun.l.google.com:19302

;====================================================================================
; 6. Codecs Configuration (/etc/asterisk/codecs.conf)
;====================================================================================

[opus]
; Opus codec for high-quality audio (recommended for voicebot)
type=opus
max_playback_rate=48000
packet_loss=20
complexity=10
cbr=no
dtx=no

;====================================================================================
; 7. Recording Configuration
;====================================================================================

; Create recording directories
; sudo mkdir -p /var/spool/asterisk/recording
; sudo mkdir -p /var/lib/asterisk/sounds/custom
; sudo chown -R asterisk:asterisk /var/spool/asterisk/recording
; sudo chown -R asterisk:asterisk /var/lib/asterisk/sounds/custom

;====================================================================================
; 8. Manager Configuration (/etc/asterisk/manager.conf) - Optional
;====================================================================================

[general]
enabled = yes
port = 5038
bindaddr = 0.0.0.0

[voicebot_manager]
secret = manager_secure_password_2024
read = all
write = all

;====================================================================================
; INSTALLATION STEPS
;====================================================================================
;
; 1. Copy this configuration to appropriate files:
;    sudo cp asterisk_config_example.conf /etc/asterisk/
;
; 2. Extract sections to individual config files
;
; 3. Update passwords and domains with your values
;
; 4. Reload Asterisk:
;    sudo asterisk -rx "core reload"
;
; 5. Verify configuration:
;    sudo asterisk -rx "ari show status"
;    sudo asterisk -rx "pjsip show endpoints"
;    sudo asterisk -rx "dialplan show incoming"
;
; 6. Test with a call:
;    asterisk -rx "originate Local/100@incoming extension 200@testing"
;
;====================================================================================

;====================================================================================
; FIREWALL CONFIGURATION
;====================================================================================
;
; Open these ports:
; - 5060/udp (SIP)
; - 5060/tcp (SIP)
; - 8088/tcp (ARI HTTP)
; - 8089/tcp (ARI HTTPS)
; - 10000-20000/udp (RTP)
;
; Example UFW commands:
; sudo ufw allow 5060/udp
; sudo ufw allow 5060/tcp
; sudo ufw allow 8088/tcp
; sudo ufw allow 10000:20000/udp
;
;====================================================================================

;====================================================================================
; AUDIO FILES NEEDED
;====================================================================================
;
; Create custom audio prompts in /var/lib/asterisk/sounds/custom/:
; - welcome-medibot.wav       "Welcome to MediBot appointment system"
; - press-1-for-appointment.wav "Press 1 to book an appointment"
; - press-2-for-emergency.wav   "Press 2 for emergency"
; - emergency-greeting.wav      "You have reached emergency services"
; - goodbye.wav                 "Thank you for calling. Goodbye."
; - invalid.wav                 "Invalid option. Please try again."
;
; Convert audio to proper format:
; sox input.mp3 -r 8000 -c 1 -e signed-integer output.wav
;
;====================================================================================

;====================================================================================
; TROUBLESHOOTING
;====================================================================================
;
; View Asterisk logs:
; tail -f /var/log/asterisk/full
; tail -f /var/log/asterisk/messages
;
; Enable verbose logging:
; asterisk -rvvvv
;
; Test ARI:
; curl -u voicebot:password http://localhost:8088/ari/channels
;
; Check Stasis apps:
; asterisk -rx "stasis show apps"
;
; Test dialplan:
; asterisk -rx "dialplan show incoming@100"
;
;====================================================================================
